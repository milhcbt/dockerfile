#!/bin/sh -e


# Add Custom UserID as "User" User
if [ "$(id -u)" != "0" ]; then
  sed "s/^user:\(.*\):[0-9]\+:\([0-9]\+\):.*:\(.*:.*\)/user:\1:$(id -u):\2:User:\3/g" < /etc/passwd > /tmp/passwd \
  && cat /tmp/passwd > /etc/passwd \
  && rm -f /tmp/passwd
fi


# Prepare var/cache directory due to volume
if [ ! -d /var/cache ]; then
  mkdir -p /var/cache \
  && chown user:root /var/cache \
  && chmod 775 /var/cache
fi


# Prepare var/cache/squid directory due to volume
if [ ! -d /var/cache/squid ]; then
  mkdir -p /var/cache/squid \
  && chown user:root /var/cache/squid \
  && chmod 775 /var/cache/squid
fi


# Prepare var/log directory due to volume
if [ ! -d /var/log ]; then
  mkdir -p /var/log \
  && chown user:root /var/log \
  && chmod 775 /var/log
fi


# Prepare var/log/squid directory due to volume
if [ ! -d /var/log/squid ]; then
  mkdir -p /var/log/squid \
  && chown user:root /var/log/squid \
  && chmod 775 /var/log/squid
fi


# Squid configuration variable
SQUID_MODE=${SQUID_MODE:-}
SQUID_CACHE_MANAGER=${SQUID_CACHE_MANAGER:-root}
SQUID_CACHE_DIR=${SQUID_CACHE_DIR:-/var/cache/squid}
SQUID_CACHE_SIZE=${SQUID_CACHE_SIZE:-100}
SQUID_CACHE_L1_SIZE=${SQUID_CACHE_L1_SIZE:-16}
SQUID_CACHE_L2_SIZE=${SQUID_CACHE_L2_SIZE:-256}
SQUID_CACHE_MEMORY_SIZE=${SQUID_CACHE_MEMORY_SIZE:-128}
SQUID_CACHE_SWAP_LOW=${SQUID_CACHE_SWAP_LOW:-80}
SQUID_CACHE_SWAP_HIGH=${SQUID_CACHE_SWAP_HIGH:-95}
SQUID_FQDNCACHE_SIZE=${SQUID_FQDNCACHE_SIZE:-4096}
SQUID_IPCACHE_SIZE=${SQUID_IPCACHE_SIZE:-4096}
SQUID_IPCACHE_LOW=${SQUID_IPCACHE_LOW:-80}
SQUID_IPCACHE_HIGH=${SQUID_IPCACHE_HIGH:-95}
SQUID_MEMORY_POOLS_LIMIT=${SQUID_MEMORY_POOLS_LIMIT:-2048}
SQUID_MAX_OBJECT_SIZE=${SQUID_MAX_OBJECT_SIZE:-12288}
SQUID_MAX_OBJECT_SIZE_MEMORY=${SQUID_MAX_OBJECT_SIZE_MEMORY:-1024}
# ------------------------------------------------
# Squid arguments variable
ARGS=${ARGS:-}
export ARGS=$ARGS
# ------------------------------------------------
# Squid configuration file
{
  echo "# Squid Configuration"
  echo ""; \
  echo "dns_v4_first                      on"; \
  echo ""; \
  echo "memory_pools                      on"; \
  echo "pipeline_prefetch                 on"; \
  echo "strip_query_terms                 off"; \
  echo "half_closed_clients               off"; \
  echo ""; \
  echo "log_mime_hdrs                     off"; \
  echo "forwarded_for                     off"; \
  echo "via                               off"; \
  echo ""; \
  echo "cache_replacement_policy          heap               LFUDA"; \
  echo "memory_replacement_policy         heap               GDSF"; \
  echo ""; \
  echo "acl localnet                      src                all"; \
  echo "acl CONNECT                       method             CONNECT"; \
  echo ""; \
  echo "request_header_access             X-Forwarded-For    deny all"; \
  echo "request_header_access             Via                deny all"; \
  echo ""; \
  echo "reply_header_access               X-Forwarded-For    deny all"; \
  echo "reply_header_access               Via                deny all"; \
  echo "reply_header_access               Alternate-Protocol deny all"; \
  echo "reply_header_access               Alt-Svc            deny all"; \
  echo ""; \
  echo "http_access                       allow              localhost manager"; \
  echo "http_access                       deny               manager"; \
  echo "http_access                       allow              localhost"; \
  echo "http_access                       allow              localnet"; \
  echo "http_access                       deny               all"; \
  echo ""; \
  echo "http_port 3127"; \
  echo "http_port 3128 ${SQUID_MODE}"; \
  echo ""; \
  echo "cache_mgr                         ${SQUID_CACHE_MANAGER}"; \
  echo "cache_dir                         aufs ${SQUID_CACHE_DIR} ${SQUID_CACHE_SIZE} ${SQUID_CACHE_L1_SIZE} ${SQUID_CACHE_L2_SIZE}"; \
  echo ""; \
  echo "cache_mem                         ${SQUID_CACHE_MEMORY_SIZE} MB"; \
  echo "cache_swap_low                    ${SQUID_CACHE_SWAP_LOW}"; \
  echo "cache_swap_high                   ${SQUID_CACHE_SWAP_HIGH}"; \
  echo ""; \
  echo "memory_pools_limit                ${SQUID_MEMORY_POOLS_LIMIT} MB"; \
  echo "maximum_object_size               ${SQUID_MAX_OBJECT_SIZE} KB"; \
  echo "maximum_object_size_in_memory     ${SQUID_MAX_OBJECT_SIZE_MEMORY} KB"; \
  echo ""; \
  echo "ipcache_size                      ${SQUID_IPCACHE_SIZE}"; \
  echo "ipcache_low                       ${SQUID_IPCACHE_LOW}"; \
  echo "ipcache_high                      ${SQUID_IPCACHE_HIGH}"; \
  echo ""; \
  echo "fqdncache_size                    ${SQUID_FQDNCACHE_SIZE}"; \
  echo ""; \
  echo "read_ahead_gap                    512 KB"; \
  echo ""; \
  echo "quick_abort_min                   1024 KB"; \
  echo "quick_abort_max                   2048 KB"; \
  echo "quick_abort_pct                   75"; \
  echo ""; \
  echo "coredump_dir                      ${SQUID_CACHE_DIR}"; \
  echo ""; \
  echo "refresh_pattern ^ftp:             1440  20% 10080"; \
  echo "refresh_pattern ^gopher:          1440   0% 1440"; \
  echo "refresh_pattern -i (/cgi-bin/|\?) 0      0% 0"; \
  echo "refresh_pattern -i .              0     75% 4320"; \
  echo ""; \
  echo "max_stale 1 day"; \
  echo ""; \
} > /etc/squid/squid.conf
# ------------------------------------------------
# Squid initialize cache directory
if [[ ! -d ${SQUID_CACHE_DIR}/00 ]]; then
  squid -f /etc/squid/squid.conf -N -z
fi
# ------------------------------------------------
# Cleaning-up configuration variable
unset SQUID_MODE
unset SQUID_CACHE_MANAGER SQUID_CACHE_DIR \
      SQUID_CACHE_SIZE SQUID_CACHE_L1_SIZE SQUID_CACHE_L2_SIZE
unset SQUID_CACHE_MEMORY_SIZE SQUID_CACHE_SWAP_LOW SQUID_CACHE_SWAP_HIGH
unset SQUID_FQDNCACHE_SIZE
unset SQUID_IPCACHE_SIZE SQUID_IPCACHE_LOW SQUID_IPCACHE_HIGH
unset SQUID_MEMORY_POOLS_LIMIT SQUID_MAX_OBJECT_SIZE SQUID_MAX_OBJECT_SIZE_MEMORY


# Execute Everything from Entries
exec "$@"
